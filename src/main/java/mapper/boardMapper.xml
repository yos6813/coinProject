<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.zerock.persistence.BoardDAO">
	<insert id="insertBoard" parameterType="org.zerock.persistence.Board">
		insert into boardTbl(writeUser, writeDate, pNo, projectDate, text, budget, pm, status)
		values(#{writeUser}, #{writeDate}, #{pNo}, #{projectDate}, #{text}, #{budget}, #{pm}, #{status});
	</insert>
	
	<select id="listBoard" parameterType="list" resultType="org.zerock.persistence.Board">
		select * from v_boardTbl 
		<choose>
			<when test="type=='pName'">
				where pName like CONCAT('%', #{keyword} , '%')
			</when>
			<when test="type=='pm'">
				where pm like CONCAT('%', #{keyword} , '%')
			</when>
		</choose>
		order by bNo desc
	</select>
	
	<select id="viewBoard" resultType="org.zerock.persistence.Board">
		select * from v_boardTbl where bNo = #{bNo};
	</select>
	
	<select id="getBoard" resultType="org.zerock.persistence.Board">
		select * from v_getBoard where bNo = #{bNo};
	</select>
	
	<insert id="insertActivity" parameterType="org.zerock.persistence.Board">
		insert into activityTbl(bNo, aName, aDate, aM, aText, aWriteD, aWriteU, aStatus)
		values(#{bNo}, #{aName}, #{aDate}, #{aM}, #{aText}, #{aWriteD}, #{aWriteU}, #{aStatus});
	</insert>
	
	<select id="ActivityList" resultType="org.zerock.persistence.Board">
		select * from v_activityTbl where bNo = #{bNo} order by aNo desc limit #{pageStart}, #{perPageNum};
	</select>
	
	<select id="ActivityList1" resultType="org.zerock.persistence.Board">
		select * from v_activityTbl where bNo = #{bNo} order by aNo desc;
	</select>
	
	<select id="countList1" resultType="org.zerock.persistence.Board">
		select * from v_activityTbl where bNo = #{bNo} and aStatus = '진행중';
	</select>
	<select id="countList2" resultType="org.zerock.persistence.Board">
		select * from v_activityTbl where bNo = #{bNo} and aStatus = '대기';
	</select>
	<select id="countList3" resultType="org.zerock.persistence.Board">
		select * from v_activityTbl where bNo = #{bNo} and aStatus = '완료';
	</select>
	<select id="countList4" resultType="org.zerock.persistence.Board">
		select * from v_activityTbl where bNo = #{bNo} and aStatus = '보류';
	</select>
	
	<select id="viewActivity" resultType="org.zerock.persistence.Board">
		select * from v_getactivityTbl where aNo = #{aNo};
	</select>
	
	<select id="listPage" parameterType="list" resultType="org.zerock.persistence.Board">
		select * from v_boardTbl where bNo > 0 order by bNo desc limit #{page}, 5;
	</select>
	
	<select id="listCriteria" parameterType="list" resultType="org.zerock.persistence.Board">
		select * from v_boardTbl where bNo > 0 order by bNo desc limit #{pageStart}, #{perPageNum};
	</select>
	
	<select id="countPaging" resultType="int">
		select count(bNo) from v_boardTbl where bNo > 0;
	</select>
	
	<select id="countAPaging" resultType="int">
		select count(aNo) from v_activityTbl where aNo > 0 and bNo = #{bNo};
	</select>
	
	<select id="countTPaging" resultType="int">
		select count(*) from v_activityTbl where aNo > 0 and aNo = #{aNo};
	</select>
	
	<insert id="insertTask" parameterType="org.zerock.persistence.Board">
		insert into taskTbl(aNo, tName, tDate, tStatus, tM, tText, tWriteD, tWriteU)
		values(#{aNo}, #{tName}, #{tDate}, #{tStatus}, #{tM}, #{tText}, #{tWriteD}, #{tWriteU});
	</insert>
	
<!-- 	<select id="listTask" parameterType="list" resultType="org.zerock.persistence.Board"> -->
<!-- 		select * from v_taskTbl where aNo = #{aNo}; -->
<!-- 	</select> -->
	
	<select id="listTask" parameterType="list" resultType="org.zerock.persistence.Board">
		select * from v_taskTbl where aNo = #{aNo} and aNo > 0 order by aNo desc limit #{pageStart}, #{perPageNum};
	</select>
	
	<select id="viewTask" resultType="org.zerock.persistence.Board">
		select * from v_getTaskTbl where bNo = #{bNo};
	</select>
	
	<select id="countTask" resultType="org.zerock.persistence.Board">
		SELECT aNo, aName, bNo, aStatus, aM,
		 COUNT(CASE WHEN tStatus = '진행중' THEN 1 END) ongoing,
		 COUNT(CASE WHEN tStatus = '대기' THEN 1 END) standby,
		 COUNT(CASE WHEN tStatus = '완료' THEN 1 END) complete,
		 COUNT(CASE WHEN tStatus = '보류' THEN 1 END) defer
		FROM v_getTasktbl group by aNo having bNo = #{bNo};
	</select>
	
	<select id="taskView" resultType="org.zerock.persistence.Board">
		select * from v_getTaskTbl where aNo = #{aNo} order by field(tStatus, '진행중', '보류', '대기', '완료');
	</select>
</mapper>